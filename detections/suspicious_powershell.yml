name: Suspicious PowerShell Encoded Command
id: det-001-v2
status: dev
description: Detects PowerShell execution with validated Base64 encoded commands, excluding known legitimate sources
author: Subh Samal
date: 2026-01-17
modified_by: Subh Samal
modified_date: 2026-01-19
version: 2.0
schedule: "*/10 * * * *"

detection:
  product: windows
  category: process_creation
  
  search: |
    index=windows sourcetype=WinEventLog:Security EventCode=4688
    | search (CommandLine="*powershell*" OR CommandLine="*pwsh*")
    | search (CommandLine="*-enc*" OR CommandLine="*-encodedcommand*")
    
    `comment("Extract the encoded command portion")`
    | rex field=CommandLine "-enc(?:odedcommand)?\s+(?<encoded_cmd>\S+)"
    | where isnotnull(encoded_cmd) AND len(encoded_cmd) >= 20
    
    `comment("Validate it's actually Base64 by attempting to decode")`
    | eval decoded_cmd=base64decode(encoded_cmd)
    | where isnotnull(decoded_cmd)
    
    `comment("Apply exclusions for known legitimate sources")`
    | search NOT [
        `comment("Exclude SYSTEM account running from legitimate services")`
        (User="NT AUTHORITY\\SYSTEM" AND ParentProcessName IN ("*\\services.exe", "*\\svchost.exe"))
        
        `comment("Exclude SCCM/Configuration Manager")`
        OR ParentProcessName IN ("*\\ccmexec.exe", "*\\CcmExec.exe", "*\\SMS*.exe")
        
        `comment("Exclude Windows Remote Management (legitimate remote PS sessions)")`
        OR ParentProcessName="*\\wsmprovhost.exe"
        
        `comment("Exclude Group Policy processing (domain-managed scripts)")`
        OR ParentProcessName="*\\gpscript.exe"
      ]
    
    | table _time, Computer, User, ParentProcessName, CommandLine, decoded_cmd
    | sort -_time

  condition: count > 0

metadata:
  severity: high
  
  mitre_attack:
    - T1059.001  # PowerShell
    - T1027      # Obfuscated Files or Information
    - T1140      # Deobfuscate/Decode Files or Information
  
  validation:
    - Base64 format validation via decode attempt
    - Minimum length requirement (20+ characters)
    - Successful decoding required
  
  exclusions:
    - "SYSTEM account running from services.exe or svchost.exe"
    - "SCCM/Configuration Manager (ccmexec.exe, SMS*.exe)"
    - "Windows Remote Management (wsmprovhost.exe)"
    - "Group Policy scripts (gpscript.exe)"
  
  false_positives:
    - "Legitimate software installers"
    - "Third-party automation tools"
    - "Custom admin scripts from non-standard locations"
  
  detection_logic:
    - "Step 1: Identify PowerShell with -enc or -encodedcommand flag"
    - "Step 2: Extract the Base64 string after the flag"
    - "Step 3: Validate it's real Base64 by attempting to decode"
    - "Step 4: Apply environment-specific exclusions"
    - "Step 5: Show decoded content for analyst review"
  
  response_actions:
    - "Review decoded command for malicious content"
    - "Verify parent process and user context are expected"
    - "If malicious: isolate system, kill process, collect memory dump"
    - "Check for network connections and file modifications"
    - "Escalate to incident response if confirmed attack"
  
  references:
    - https://attack.mitre.org/techniques/T1059/001/
    - https://attack.mitre.org/techniques/T1027/
    - https://attack.mitre.org/techniques/T1140/